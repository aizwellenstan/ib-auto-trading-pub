import sys 
mainFolder = '../'
sys.path.append(mainFolder)
from modules.data import GetNpData
from modules.movingAverage import SmaArr
import numpy as np
from modules.aiztradingview import GetAll

from numba import jit
def backtest(npArr, closeArr, Sma25, biasVal):
    tpVal = 1.19
    totalGain = 0
    totalLoss = 0
    win = 0
    loss = 0
    trades = 0
    longTradeOP = np.empty(0)
    shortTradeOP = np.empty(0)
    longTrades = []
    shortTrades = []

    for i in range(2, len(npArr)):
        close = closeArr[i-1]
        sma = Sma25[i-1]
        bias = (close-sma)/sma

        high = npArr[i-1][1]
        low = npArr[i-1][2]
        close = npArr[i-1][3]

        longTP = False
        shortTP = False

        if len(longTrades) > 0:
            newLongTrades = []
            for op, sl, tp in longTrades:
                if npArr[i-1][2] < sl + 0.01:
                    totalLoss += (sl-op)/op
                    loss += 1
                elif npArr[i-1][1] > tp: 
                    totalGain += (tp-op)/op
                    win += 1
            longTrades = newLongTrades

        if (
            bias < biasVal
        ):
            op = npArr[i][0]
            if op < 0.01: continue
            longTradeOP = np.append(longTradeOP,op)
            trades += 1
            tp = op*1.085714286
            sl = op*0.981
            longTrades.append((op,sl,tp))

    totalLoss -= 1
    wr = 0
    if win+loss > 0:
        wr = win/(win+loss)
    return totalGain, totalLoss, trades, wr

import sys
def main():
    try:
        biasDict = {}
        totalDict = {}
        symbolList = GetAll()
        for symbol in symbolList:
            npArr = GetNpData(symbol,'USD',True)
            if len(npArr) < 1: continue
            closeArr = npArr[:, 3]
            Sma25 = SmaArr(closeArr,25)

            maxProfit = 0
            minBiasVal = 0
            biasVal = 0
            while biasVal >= -.3:
                biasVal -= 0.001
                totalGain, totalLoss, trades, wr = backtest(npArr, closeArr, Sma25, biasVal)
                profit = totalGain + totalLoss
                if profit > maxProfit:
                    maxProfit = profit
                    minBiasVal = biasVal
                    print(totalGain, totalLoss, trades, wr, biasVal)
                    print(f"maxProfit {maxProfit} minBiasVal {biasVal}")
            print(f"maxProfit {maxProfit} minBiasVal {biasVal}")
            if maxProfit > 0:
                biasDict[symbol] = minBiasVal
                totalDict[symbol] = maxProfit
                totalDict = dict(sorted(totalDict.items(), key=lambda item: item[1], reverse=True))
                print(totalDict)
                print(biasDict[next(iter(totalDict))])
        totalDict = dict(sorted(totalDict.items(), key=lambda item: item[1], reverse=True))
        print(totalDict)
        print(biasDict[next(iter(totalDict))])
    except Exception as e:
        print("Error on line {}".format(sys.exc_info()[-1].tb_lineno))
        print(e)
main()

# {'GFF': 36.15242878400029, 'GMGI': 7.727142915999929, 'PCYG': 4.955571477999946, 'CHE': 2.723000023999984, 'BOSC': 2.537857185999945, 'PCYO': 2.492000019999993, 'AMS': 2.244857187999937, 'TAIT': 2.0478571659999814, 'HQI': 1.7067143099999775, 'NHTC': 1.5694285899999905, 'ARTW': 1.3132857840001435, 'OPHC': 1.1705714599999624, 'WHLM': 0.8151428959999425, 'MGYR': 0.7667142979999975, 'SCKT': 0.5974285859999924, 'CCEL': 0.5670000119999967, 'NVEC': 0.5661428679999965, 'CFBK': 0.5134285879999849, 'WFCF': 0.5020000139999925, 'BOKF': 0.4200000059999982, 'LIVE': 0.418571457999958, 'VBFC': 0.3461428659999979, 'ACHC': 0.20271430599997764, 'NSYS': 0.17642858199999711, 'WTBA': 0.13585714999999787, 'CMT': 0.11857143799999736, 'PNBK': 0.10971429599999682, 'INDB': 0.09242858399999365, 'RCMT': 0.06328572599999305}
# {'RGLD': 32.95164244077184, 'AIRT': 32.66588137352195, 'GFF': 26.164405760082357, 'HGBL': 22.174648595599848, 'ARTW': 21.96897662434769, 'PCYG': 20.824164889795675, 'AAME': 18.480622495176654, 'GMGI': 15.422508252316852, 'CPSH': 15.23907626080931, 'DCO': 15.028937654189926, 'PCYO': 14.991005037151503, 'NSYS': 14.395920590045344, 'ESTE': 14.046962280042283, 'PTSI': 13.590881403626904, 'CODA': 13.478445190776224, 'SMED': 12.004941306836994, 'KOSS': 11.109162512999156, 'SNFCA':
# 10.509293885701767, 'AMS': 10.485606562444058, 'WHLM': 10.196734901675097, 'PBHC': 10.156536565081876, 'USLM': 9.780920479246111, 'CLFD': 9.588270970755277, 'PNBK': 9.13286434103173, 'ALOT': 9.050865300828576, 'BOSC': 8.91234811441562, 'AATC': 8.836788305405715, 'TSRI': 8.70389775285275, 'ITIC': 8.702067496839309, 'NHTC': 8.697903056305137, 'CCEL': 8.59863215571856, 'SIG': 8.269699766790687, 'OPHC': 8.265429852096421, 'UBCP': 8.255729775719368, 'CFBK': 7.978838476931941, 'UONE': 7.9712082692943556, 'EGY': 7.961038351769309, 'CLWT': 7.87004712540676, 'SMID': 7.684846976655057, 'EVI': 7.673618921716821, 'NVEC': 7.672963433606682, 'AMOT': 7.6425260862312765, 'SENEB': 7.513991573079116, 'BOKF': 7.429989972554845, 'BKSC': 7.377797742275787, 'PNRG': 7.373568140001516, 'UFPT': 7.373505762060973,
# 'TRNS': 7.134313122117666, 'VBFC': 7.039484574032127, 'FSTR': 6.9979523625878155, 'PPIH': 6.872243865823748, 'DIT': 6.796133769398006, 'IBCP': 6.70611725816817, 'CPE': 6.7017829896638546, 'PLBC': 6.582021142913781, 'CYAN': 6.5518382262465735, 'AMEH': 6.44253545775436, 'PDEX': 6.381430949729975, 'QCRH': 6.3308441908635285, 'BOTJ': 6.2995162890514464,
# 'INDB': 6.21384480996547, 'CHE': 6.073825198061881, 'UBOH': 6.062817490228909, 'NBN': 6.036750108232172, 'MED': 6.021216102538119, 'GLBZ': 5.945814149302248, 'SGMA': 5.786526059117165, 'HWKN': 5.741632958266907, 'HIFS': 5.7106761406387445, 'TMP': 5.699750871971794, 'HQI': 5.576051620643531, 'FCCO': 5.540945719454512, 'BBSI': 5.527886835223675, 'ABMD': 5.48486889648537, 'MCRI': 5.3047636679045, 'FUNC': 5.291339829855777, 'TAIT': 5.123240111791938, 'SCKT': 5.108885364931485, 'HIHO': 5.103469802397079, 'ARKR': 5.064433650374659, 'KELYB': 4.930537122486893, 'FNCB': 4.855973630340227, 'ACNB': 4.835194410802372, 'CVLY': 4.761032088123717, 'FLXS': 4.74672811020039, 'ISDR': 4.683499169934627, 'GCBC': 4.666669340416908, 'OPOF': 4.662084244485781, 'MGYR': 4.643092905213891, 'PDCE': 4.6360940822701675, 'CPK': 4.594543896266774, 'LWAY': 4.575792101626574, 'AUBN':
# 4.565187253047534, 'PNR': 4.56257508209522, 'CVCY': 4.400791030634841, 'EMCF': 4.326584528568166, 'HDSN': 4.1071248839599015, 'AGX': 4.055332151794659, 'WFCF':
# 4.023757350603246, 'RFIL': 3.9996414065983146, 'ASRV': 3.9964284505623837, 'OVBC': 3.8932235251714347, 'ESOA': 3.871023129063757, 'FRAF': 3.8700435967132076, 'PTRS': 3.8558689041672913, 'CCRD': 3.82571978375678, 'QRTEB': 3.765669674461816, 'INCR': 3.720583296389235, 'RICK': 3.6419108253464287, 'CBAN': 3.604915429122371, 'WEYS': 3.5365919504290764, 'CIZN': 3.529692565641573, 'WILC': 3.5188764981252616, 'FCAP': 3.516768445010733, 'MITK': 3.474142479154512, 'PEBK': 3.452495512451752, 'LIVE': 3.448943581918183, 'DLHC': 3.394998041126822, 'LAKE': 3.340434544404941, 'SMBC': 3.3301964082044155, 'EVBN': 3.3140766743954284, 'EXPO': 3.3131090638778584, 'CIX': 3.2663598573732484, 'UNB': 3.2128667804127744, 'HWBK': 3.2094308103191374, 'MXC': 3.1517477867352515, 'FNB': 3.125143248068369, 'TZOO': 3.1146555992758844, 'JOB': 3.107868742221452, 'LARK': 3.083521473372109, 'BGI': 3.083447294761285, 'USAK': 3.081542809487315, 'STRL':
# 3.072414621252417, 'CATY': 3.068667121537059, 'NBTB': 3.057193615676237, 'SFST': 3.0197134138355404, 'ACHC': 3.01441470965284, 'FUSB': 3.007882514150162, 'SENEA': 2.9500421472852123, 'HMNF': 2.8970038285874486, 'FDBC': 2.8692323731356533, 'CWBC': 2.8383215430230386, 'COFS': 2.8098378307673255, 'WDFC': 2.776085785163806, 'SOTK': 2.761588692010113, 'SBFG': 2.761230684791193, 'CADE':
# 2.733885874921026, 'GABC': 2.7321472715198842, 'APPS': 2.7256955422184967, 'MGEE': 2.7150832530868287, 'WASH': 2.685750439996575, 'KFFB': 2.683935064607488, 'CZNC': 2.631643250317346, 'SMMF':
# 2.6068482733705025, 'CHCI': 2.595321143212445, 'MPB': 2.5071127684023224, 'SMBK': 2.492640800024201, 'ACNT': 2.48003232528497, 'FBNC': 2.459943012783717, 'OPBK': 2.4314634114550584, 'OVLY': 2.3999805074577267, 'AE': 2.393269392948616, 'NRIM': 2.3753084578691173, 'DORM': 2.341487090766874, 'ELA': 2.279981507971499, 'CZFS': 2.251693550925718, 'RADA': 2.24062559924808, 'FCNCA': 2.2396464610492473, 'ATRI': 2.238668233134253, 'ARTNA': 2.2159845565652967, 'CIVB': 2.206742451923705, 'CPHC': 2.197384649480242, 'PEBO': 2.165476558246459, 'CHMG': 2.1654366690169127, 'FORTY': 2.1567194255439466, 'KTCC': 2.1506768972666634, 'SPNS': 2.0631785623005747, 'USPH': 2.0616751968814633, 'CPF': 2.060893594708971, 'PATK': 2.0416460153595093, 'NWFL': 2.037281617902247, 'EBTC': 2.0308968445002904, 'AUB': 2.002683249134167, 'EPSN': 1.9957176171526747, 'VABK': 1.989868397873508, 'NTIP': 1.912885334685762, 'GLBS': 1.8974495517217727, 'NECB': 1.8733923278700306, 'HFBL': 1.8713506267508588, 'LCNB': 1.8367398257045913, 'CHCO': 1.8230065205335526, 'CFFI': 1.8216448255740532, 'CTBI': 1.8153833495560443, 'WDS': 1.791062005089351, 'LMST': 1.7722285170902476, 'ESEA': 1.7504698620004167, 'STRT': 1.7360161428786842, 'UG': 1.7321559865356662, 'SSL': 1.7301593303160345, 'RCKY': 1.7074079045418937,
# 'EGBN': 1.7041596653146085, 'UFCS': 1.7028121129528238, 'VLGEA': 1.695487879267378, 'VSEC': 1.6902890279159655, 'TOPS': 1.6861447162904217, 'JBSS': 1.6695752274269964, 'NWLI': 1.6509696398528346, 'OFLX': 1.6247329780777795,
# 'POWL': 1.5834896632057713, 'CCNE': 1.5795921918584215, 'AVD': 1.5069493154987796, 'FBMS': 1.5053251217089385, 'FRME': 1.4957128876344932, 'SAL': 1.4935225956588982, 'CVR': 1.493382355647698,
# 'COLB': 1.488882731265015, 'CZWI': 1.4838259463039898, 'PWOD': 1.4787748818634938, 'FELE': 1.4511636675045896, 'KWR': 1.450203011715244, 'FMAO': 1.4133069128931492, 'RVSB': 1.4000681912151407, 'FRBA': 1.3939488512102303, 'BELFA': 1.393456113021461, 'AZZ':
# 1.3874388152756278, 'AROW': 1.384882877125949, 'FMNB': 1.3622130397673917, 'THFF': 1.3245966958371795, 'FXNC': 1.3109301319860958, 'TCFC': 1.2986966797248858, 'MPAA': 1.2972938524478472, 'CAJ': 1.2889779197720714, 'CHDN': 1.2732985986737138, 'ODFL': 1.2672116624186742, 'JOUT': 1.2650333301434848, 'RELL': 1.2548436791348898, 'CBU': 1.2474223980505252, 'EBMT': 1.245417816194783, 'PFIS': 1.2125494644304045, 'CATO':
# 1.2082264473197881, 'BCBP': 1.1959561582774914, 'ATLO': 1.1864844036483246, 'UTMD': 1.1853361369051543, 'AMNB': 1.1600171791017582, 'STBA': 1.1470657411673333,
# 'LSBK': 1.1305165780795212, 'LBTYB': 1.1247948120631315, 'UBFO': 1.104447942356833, 'PLPC': 1.0934886109456547, 'BFC': 1.092756790026952, 'WTBA': 1.0828124897185454, 'UNTY': 1.0825522532834668, 'JCTCF': 1.067470174262148, 'CATC': 1.0536838590085496, 'UMBF': 1.0104359230738016, 'CCBG': 0.9482293418827883, 'OBT': 0.9416727233658669, 'SFBC': 0.9296740991242217, 'MBCN': 0.9126585892281436, 'ORRF': 0.9117120804267107, 'MGRC': 0.9029815501463148, 'WFG': 0.8890277596244532, 'SMLR':
# 0.8842519731103238, 'NKSH': 0.8763558000522647, 'FMBH': 0.8725281417216328, 'TNC': 0.8681194773687855, 'FRST': 0.8464985878279103, 'WAFU': 0.8233472754423672, 'ASYS': 0.8139935969145071, 'LGO': 0.7976922743864101, 'CBFV': 0.7904655255280677, 'HURC': 0.7878058649249962, 'FNLC': 0.7839250635857447, 'AUY': 0.7768810786992855, 'BANF': 0.7731634564390211, 'FNWD': 0.7474489866689044, 'SGA': 0.7328092380156459, 'SYBT':
# 0.7164309990624957, 'LINC': 0.6635962091523644, 'PPBI': 0.6607629793882293, 'CVCO': 0.6603648787921674, 'ZDGE': 0.6299785862421219, 'PSO': 0.6014262058157711, 'RIO': 0.593415308887717, 'BSRR': 0.5910361453763171, 'CRH': 0.5871418017028991, 'SILC': 0.586564900235448, 'LAD': 0.5837054516768783, 'HWC': 0.5698946060757795, 'LKFN': 0.5654535610521414, 'ACU': 0.5631977857374704, 'ESLT':
# 0.5566572394678908, 'FSI': 0.5564854224908226, 'RVP': 0.5449597225450713, 'SASR': 0.5436604575583885, 'SSBI': 0.5297036466774769, 'WLY': 0.5240426370970941, 'SBCF': 0.5239162079677566, 'HTLF': 0.5030885342941156, 'ABCB': 0.49507554321882363, 'CNOB': 0.4779748371639716, 'OSBC': 0.4779588466884235, 'DSGR': 0.47634693401937334, 'EVC': 0.46879521809714064, 'ELMD': 0.4465597486522519, 'HSON': 0.4254216524350216, 'FCBC': 0.41838167040958574, 'NVS': 0.415439567245274, 'BRC': 0.4061114944935209, 'BMRC': 0.39411830704392603, 'JHX': 0.36182605224262665, 'GSBC': 0.36090022500939334, 'PHG': 0.33758017296686704, 'HFWA': 0.33165962361181034, 'RCMT': 0.3253476968338411, 'UVSP':
# 0.3092996942266115, 'EDRY': 0.30829580516239297, 'CMT': 0.3049198919010685, 'TFII': 0.3027340665384267, 'POWI': 0.29516227421516494, 'FBP': 0.28154762858959437, 'CULL': 0.2625536897195554, 'WF': 0.25739510166817015, 'CTRM':
# 0.25509961134097847, 'HTBK': 0.2505884897046009, 'SBSI': 0.2449836947905979, 'CASH': 0.24376761794610413, 'PRK': 0.24039451195996975, 'ICL': 0.23538554892417762, 'TRST': 0.2187475632449587, 'GMAB': 0.21664018711147393, 'SONY': 0.20548177429318137, 'BRBS':
# 0.16245485891842137, 'LFVN': 0.15981407086377536, 'HVBC': 0.1573385174258387, 'DEO': 0.1450778417138059, 'LSXMB': 0.13537651325585764, 'SAH': 0.13308773721902045, 'MGPI': 0.13047810969340823,
# 'BZH': 0.11485755407140164, 'MERC': 0.1144887302373947, 'BCML':
# 0.09911130191957396, 'NTWK': 0.0967539945394722, 'SAP': 0.09079788346626039, 'STLA': 0.0866060685738882, 'BDL': 0.08049545640184252, 'WSFS': 0.07630921711150052, 'HOVNP': 0.06733119730234982,
# 'DLA': 0.0599938479864397, 'NFBK': 0.04671858788923622, 'KEN': 0.04065813933408591, 'FLNG': 0.03287217941146037, 'PROV': 0.025795669655993336, 'MNSB': 0.01630312139833867, 'SRCE': 0.003654852137206177, 'FBIZ': 0.002551662269196786}